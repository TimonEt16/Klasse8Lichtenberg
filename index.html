import React, { useState, useEffect } from 'react';
import { 
  Clock, Plus, Edit2, Trash2, Bell, Save, X, 
  AlertTriangle, Check, ChevronLeft, ChevronRight, 
  Calendar, Target, BookOpen, Sun, Moon, 
  Download, Repeat, AlertCircle, MoreVertical 
} from 'lucide-react';
import { toPng } from 'html-to-image';
import jsPDF from 'jspdf';

const WeeklyPlanner = () => {
  // Load schedule from localStorage or use initial
  const loadSchedule = () => {
    const saved = localStorage.getItem('weeklyPlannerSchedule');
    const currentWeek = localStorage.getItem('currentWeekNumber');
    const now = new Date();
    const currentWeekNumber = Math.floor(now.getDate() / 7);
    
    if (!saved || !currentWeek || parseInt(currentWeek) !== currentWeekNumber) {
      localStorage.setItem('currentWeekNumber', currentWeekNumber.toString());
      return getInitialSchedule();
    }
    
    return JSON.parse(saved);
  };

  const getInitialSchedule = () => ({
    0: [
      { id: 1, type: 'sleep', title: 'Ausschlafen m√∂glich', time: '', recurring: true, editable: true },
      { id: 2, type: 'lesson', title: 'Novakid', time: '10:00 ‚Äì 10:30', recurring: true, editable: true },
      { id: 3, type: 'study', title: 'Lernen, Erholen, Planen', time: 'Nachmittags frei', recurring: true, editable: true }
    ],
    // ... (rest of initial schedule remains the same)
  });

  // State management
  const [currentDay, setCurrentDay] = useState(new Date().getDay());
  const [showNotification, setShowNotification] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [newTaskForm, setNewTaskForm] = useState({ show: false, day: 0 });
  const [schedule, setSchedule] = useState(loadSchedule());
  const [showSuccess, setShowSuccess] = useState(false);
  const [showWeekView, setShowWeekView] = useState(false);
  const [filters, setFilters] = useState({ type: 'all' });
  const [searchTerm, setSearchTerm] = useState('');
  const [darkMode, setDarkMode] = useState(false);
  const [notificationTime] = useState(6);
  const [activeNotifications, setActiveNotifications] = useState([]);
  const [showExportOptions, setShowExportOptions] = useState(false);
  const [currentWeekOffset, setCurrentWeekOffset] = useState(0);

  const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
  const dayEmojis = ['üò¥', 'üè´', 'üè´', 'üè´', 'üè´', 'üè´', 'üèãÔ∏è'];

  // Save to localStorage
  useEffect(() => {
    localStorage.setItem('weeklyPlannerSchedule', JSON.stringify(schedule));
    checkForNotifications();
  }, [schedule]);

  // Check for notification time
  useEffect(() => {
    const checkNotificationTime = () => {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      
      if (hours === notificationTime && minutes === 0) {
        setShowNotification(true);
        showBrowserNotification('Tages√ºbersicht', `Guten Morgen! Heute ist ${days[new Date().getDay()]}`);
      }
    };

    checkNotificationTime();
    const interval = setInterval(checkNotificationTime, 60000);
    return () => clearInterval(interval);
  }, [notificationTime]);

  // Dark mode effect
  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
      document.documentElement.style.backgroundColor = '#111827';
    } else {
      document.documentElement.classList.remove('dark');
      document.documentElement.style.backgroundColor = '#f3f4f6';
    }
  }, [darkMode]);

  // ... (rest of the utility functions remain the same)

  const TaskForm = ({ task, onSave, onCancel }) => {
    const [formData, setFormData] = useState({
      title: task?.title || '',
      time: task?.time || '',
      type: task?.type || 'study',
      date: task?.date || '',
      studyDays: task?.studyDays || 0,
      notes: task?.notes || '',
      recurring: task?.recurring || false,
      notification: task?.notification || false
    });

    return (
      <div className={`p-6 rounded-xl shadow-lg ${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-white border border-gray-200'}`}>
        <h3 className={`text-lg font-semibold mb-4 ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>
          {task ? 'Aufgabe bearbeiten' : 'Neue Aufgabe'}
        </h3>
        
        <div className="space-y-4">
          <div>
            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Aufgabentyp</label>
            <select
              value={formData.type}
              onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}
              className={`w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all ${
                darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
              }`}
            >
              <option value="study">üß† Lernen</option>
              <option value="test">üìù Test/Klausur</option>
              <option value="work">üõí Arbeit</option>
              <option value="sport">üèä Sport</option>
              <option value="music">üéº Musik</option>
              <option value="lesson">üìò Unterricht</option>
              <option value="free">üéØ Freizeit</option>
              <option value="school">üè´ Schule</option>
              <option value="appointment">üìÖ Termin</option>
              <option value="hobby">üé® Hobby</option>
            </select>
          </div>
          
          <div>
            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Titel*</label>
            <input
              type="text"
              placeholder="Aufgabe/Termin"
              value={formData.title}
              onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
              className={`w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all ${
                darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
              }`}
            />
          </div>
          
          <div>
            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Zeit</label>
            <input
              type="text"
              placeholder="z.B. 14:00 - 15:30"
              value={formData.time}
              onChange={(e) => setFormData(prev => ({ ...prev, time: e.target.value }))}
              className={`w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all ${
                darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
              }`}
            />
          </div>

          <div>
            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Notizen</label>
            <textarea
              placeholder="Optionale Notizen"
              value={formData.notes}
              onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
              className={`w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent h-24 resize-none transition-all ${
                darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
              }`}
            />
          </div>
          
          {formData.type === 'test' && (
            <div className="space-y-4">
              <div>
                <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Datum</label>
                <input
                  type="date"
                  value={formData.date}
                  onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                  className={`w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                    darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
                  }`}
                />
              </div>
              
              <div>
                <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Lerntage vorher</label>
                <input
                  type="number"
                  min="0"
                  max="21"
                  value={formData.studyDays}
                  onChange={(e) => setFormData(prev => ({ ...prev, studyDays: parseInt(e.target.value) || 0 }))}
                  className={`w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                    darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
                  }`}
                />
              </div>
            </div>
          )}
          
          <div className="flex flex-wrap gap-4">
            <label className="flex items-center gap-2 cursor-pointer">
              <div className={`relative w-10 h-5 rounded-full transition-all ${
                formData.recurring 
                  ? 'bg-blue-500' 
                  : darkMode ? 'bg-gray-600' : 'bg-gray-300'
              }`}>
                <div className={`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform ${
                  formData.recurring ? 'translate-x-5' : ''
                }`}></div>
              </div>
              <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>W√∂chentlich</span>
            </label>
            
            <label className="flex items-center gap-2 cursor-pointer">
              <div className={`relative w-10 h-5 rounded-full transition-all ${
                formData.notification 
                  ? 'bg-green-500' 
                  : darkMode ? 'bg-gray-600' : 'bg-gray-300'
              }`}>
                <div className={`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform ${
                  formData.notification ? 'translate-x-5' : ''
                }`}></div>
              </div>
              <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Erinnerung</span>
            </label>
          </div>
          
          <div className="flex gap-3 pt-2">
            <button
              onClick={() => onSave(formData)}
              disabled={!formData.title.trim()}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-all ${
                !formData.title.trim() 
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                  : 'bg-blue-600 hover:bg-blue-700 text-white shadow-md'
              }`}
            >
              <Save className="w-4 h-4" /> Speichern
            </button>
            <button
              onClick={onCancel}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg border transition-all ${
                darkMode 
                  ? 'bg-gray-700 border-gray-600 hover:bg-gray-600 text-gray-200' 
                  : 'bg-white border-gray-300 hover:bg-gray-50 text-gray-700'
              }`}
            >
              <X className="w-4 h-4" /> Abbrechen
            </button>
          </div>
        </div>
      </div>
    );
  };

  const upcomingTests = getUpcomingTests();
  const weeklyStats = calculateWeeklyStats();
  const weekDates = getCurrentWeekDates();

  return (
    <div className={`min-h-screen transition-colors duration-200 ${darkMode ? 'dark bg-gray-900' : 'bg-gray-50'}`}>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {/* Header */}
        <header className={`rounded-2xl shadow-md overflow-hidden mb-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
          <div className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 md:p-8">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between">
              <div className="mb-4 md:mb-0">
                <h1 className="text-2xl md:text-3xl font-bold mb-2 flex items-center gap-2">
                  <span className="bg-white/20 p-2 rounded-lg">
                    <Calendar className="w-5 h-5" />
                  </span>
                  Mein Wochenplaner
                </h1>
                <p className="opacity-90 text-sm md:text-base">
                  Organisiere deine Woche intelligent und effizient
                </p>
              </div>
              
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setDarkMode(!darkMode)}
                  className={`p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-yellow-300' : 'bg-white/20 hover:bg-white/30 text-white'}`}
                  title={darkMode ? 'Hellmodus' : 'Dunkelmodus'}
                >
                  {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                </button>
                
                <div className="relative">
                  <button
                    onClick={() => setShowExportOptions(!showExportOptions)}
                    className={`p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white/20 hover:bg-white/30'}`}
                    title="Exportieren"
                  >
                    <Download className="w-5 h-5 text-white" />
                  </button>
                  
                  {showExportOptions && (
                    <div className={`absolute right-0 mt-2 w-48 rounded-xl shadow-xl py-1 z-10 overflow-hidden ${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-white border border-gray-200'}`}>
                      <button
                        onClick={() => {
                          exportToPDF();
                          setShowExportOptions(false);
                        }}
                        className={`block w-full text-left px-4 py-2.5 text-sm transition-colors ${
                          darkMode 
                            ? 'text-gray-200 hover:bg-gray-600' 
                            : 'text-gray-700 hover:bg-gray-100'
                        }`}
                      >
                        Als PDF exportieren
                      </button>
                      <button
                        onClick={() => {
                          exportToImage();
                          setShowExportOptions(false);
                        }}
                        className={`block w-full text-left px-4 py-2.5 text-sm transition-colors ${
                          darkMode 
                            ? 'text-gray-200 hover:bg-gray-600' 
                            : 'text-gray-700 hover:bg-gray-100'
                        }`}
                      >
                        Als Bild exportieren
                      </button>
                      <button
                        onClick={() => {
                          exportToICal();
                          setShowExportOptions(false);
                        }}
                        className={`block w-full text-left px-4 py-2.5 text-sm transition-colors ${
                          darkMode 
                            ? 'text-gray-200 hover:bg-gray-600' 
                            : 'text-gray-700 hover:bg-gray-100'
                        }`}
                      >
                        Als iCal exportieren
                      </button>
                    </div>
                  )}
                </div>
                
                <button
                  onClick={() => setShowWeekView(!showWeekView)}
                  className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-all ${
                    darkMode 
                      ? 'bg-gray-700 hover:bg-gray-600 text-white' 
                      : 'bg-white/20 hover:bg-white/30 text-white'
                  }`}
                >
                  <Calendar className="w-4 h-4" />
                  <span className="hidden sm:inline">
                    {showWeekView ? 'Tagesansicht' : 'Wochenansicht'}
                  </span>
                </button>
              </div>
            </div>
          </div>
          
          {/* Stats */}
          <div className={`p-4 border-t ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-gray-50'}`}>
            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
              {[
                { value: `${weeklyStats.workHours}h`, label: 'Arbeitszeit', color: 'text-blue-500' },
                { value: weeklyStats.studyTasks, label: 'Lernaufgaben', color: 'text-green-500' },
                { value: weeklyStats.sportTasks, label: 'Sport-Termine', color: 'text-orange-500' },
                { value: weeklyStats.upcomingTests, label: 'Anstehende Tests', color: 'text-red-500' },
                { value: weeklyStats.recurringTasks, label: 'Wiederkehrend', color: 'text-purple-500' }
              ].map((stat, index) => (
                <div 
                  key={index} 
                  className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'} shadow-sm`}
                >
                  <div className={`text-xl font-bold ${stat.color}`}>{stat.value}</div>
                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{stat.label}</div>
                </div>
              ))}
            </div>
          </div>
        </header>

        {/* Alerts */}
        <div className="space-y-4 mb-6">
          {/* Success message */}
          {showSuccess && (
            <div className={`p-4 rounded-xl flex items-center gap-3 animate-fade-in ${
              darkMode 
                ? 'bg-green-900/50 border border-green-800' 
                : 'bg-green-100 border border-green-200'
            }`}>
              <div className={`p-1.5 rounded-full ${darkMode ? 'bg-green-800' : 'bg-green-200'}`}>
                <Check className="w-4 h-4 text-green-600 dark:text-green-300" />
              </div>
              <span className={`font-medium ${darkMode ? 'text-green-100' : 'text-green-800'}`}>
                √Ñnderungen erfolgreich gespeichert!
              </span>
            </div>
          )}

          {/* Active notifications */}
          {activeNotifications.length > 0 && (
            <div className={`p-4 rounded-xl flex items-start gap-3 ${
              darkMode 
                ? 'bg-blue-900/50 border border-blue-800' 
                : 'bg-blue-50 border border-blue-200'
            }`}>
              <div className={`p-1.5 rounded-full ${darkMode ? 'bg-blue-800' : 'bg-blue-200'}`}>
                <AlertCircle className="w-4 h-4 text-blue-600 dark:text-blue-300" />
              </div>
              <div className="flex-1">
                <h3 className={`font-medium mb-2 ${darkMode ? 'text-blue-100' : 'text-blue-800'}`}>
                  üîî Aktive Erinnerungen
                </h3>
                <div className="space-y-2">
                  {activeNotifications.map(notification => (
                    <div 
                      key={notification.id} 
                      className={`text-sm ${darkMode ? 'text-blue-200' : 'text-blue-700'}`}
                    >
                      <span className="font-medium">{notification.title}</span> - {notification.message}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Upcoming tests */}
          {upcomingTests.length > 0 && (
            <div className={`p-4 rounded-xl flex items-start gap-3 ${
              darkMode 
                ? 'bg-orange-900/50 border border-orange-800' 
                : 'bg-orange-50 border border-orange-200'
            }`}>
              <div className={`p-1.5 rounded-full ${darkMode ? 'bg-orange-800' : 'bg-orange-200'}`}>
                <AlertTriangle className="w-4 h-4 text-orange-600 dark:text-orange-300" />
              </div>
              <div className="flex-1">
                <h3 className={`font-medium mb-2 ${darkMode ? 'text-orange-100' : 'text-orange-800'}`}>
                  üìù Anstehende Tests/Klausuren
                </h3>
                <div className="space-y-2">
                  {upcomingTests.slice(0, 3).map(test => (
                    <div 
                      key={test.id} 
                      className={`text-sm ${darkMode ? 'text-orange-200' : 'text-orange-700'}`}
                    >
                      <span className="font-medium">{test.title}</span> - {test.dayName} 
                      {test.daysUntil === 0 ? ' (Heute!)' : 
                       test.daysUntil === 1 ? ' (Morgen)' : 
                       ` (in ${test.daysUntil} Tagen)`}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Morning notification */}
          {showNotification && (
            <div className={`p-4 rounded-xl flex items-start gap-3 ${
              darkMode 
                ? 'bg-yellow-900/50 border border-yellow-800' 
                : 'bg-yellow-50 border border-yellow-200'
            }`}>
              <div className={`p-1.5 rounded-full ${darkMode ? 'bg-yellow-800' : 'bg-yellow-200'}`}>
                <Bell className="w-4 h-4 text-yellow-600 dark:text-yellow-300" />
              </div>
              <div className="flex-1">
                <div className="flex justify-between items-start">
                  <div>
                    <h3 className={`font-medium mb-2 ${darkMode ? 'text-yellow-100' : 'text-yellow-800'}`}>
                      üåÖ Guten Morgen! Heute ist {days[currentDay]}
                    </h3>
                    <div className="space-y-2">
                      {getTodaysTasks().slice(0, 4).map(task => (
                        <div key={task.id} className="flex items-center gap-2">
                          <span className="text-lg">{getTypeEmoji(task.type)}</span>
                          <span className={darkMode ? 'text-yellow-200' : 'text-yellow-700'}>
                            <span className="font-medium">{task.title}</span> 
                            {task.time && (
                              <span className={darkMode ? 'text-yellow-300' : 'text-yellow-600'}> ({task.time})</span>
                            )}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                  <button
                    onClick={() => setShowNotification(false)}
                    className={darkMode ? 'text-yellow-300 hover:text-yellow-100' : 'text-yellow-600 hover:text-yellow-800'}
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Main content */}
        <main className={`rounded-2xl shadow-md overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
          {!showWeekView ? (
            <>
              {/* Day tabs */}
              <div className={`flex overflow-x-auto p-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                <button
                  onClick={() => setCurrentDay(prev => (prev === 0 ? 6 : prev - 1))}
                  className={`p-2 rounded-lg transition-colors ${darkMode ? 'text-gray-300 hover:bg-gray-600' : 'text-gray-600 hover:bg-gray-200'}`}
                >
                  <ChevronLeft className="w-5 h-5" />
                </button>
                
                {days.map((day, index) => (
                  <button
                    key={index}
                    onClick={() => setCurrentDay(index)}
                    className={`flex-1 min-w-0 px-3 py-3 mx-1 rounded-xl transition-all ${
                      currentDay === index
                        ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg transform scale-[1.02]'
                        : darkMode 
                          ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' 
                          : 'bg-white text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    <div className="flex flex-col items-center">
                      <div className="text-xl mb-1">{dayEmojis[index]}</div>
                      <div className="font-medium text-sm">{day.substring(0, 3)}</div>
                      <div className={`text-xs mt-1 ${
                        currentDay === index 
                          ? 'text-white/80' 
                          : darkMode ? 'text-gray-400' : 'text-gray-500'
                      }`}>
                        {getTasksForDay(index).length} {getTasksForDay(index).length === 1 ? 'Aufgabe' : 'Aufgaben'}
                      </div>
                    </div>
                  </button>
                ))}
                
                <button
                  onClick={() => setCurrentDay(prev => (prev === 6 ? 0 : prev + 1))}
                  className={`p-2 rounded-lg transition-colors ${darkMode ? 'text-gray-300 hover:bg-gray-600' : 'text-gray-600 hover:bg-gray-200'}`}
                >
                  <ChevronRight className="w-5 h-5" />
                </button>
              </div>

              {/* Search and filter */}
              <div className={`p-4 border-b ${darkMode ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'}`}>
                <div className="flex flex-col sm:flex-row gap-3">
                  <div className="flex-1 relative">
                    <input
                      type="text"
                      placeholder="Aufgaben suchen..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 rounded-xl border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all ${
                        darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
                      }`}
                    />
                    <div className={`absolute left-3 top-2.5 ${
                      darkMode ? 'text-gray-400' : 'text-gray-500'
                    }`}>
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>
                  </div>
                  
                  <select
                    value={filters.type}
                    onChange={(e) => setFilters(prev => ({ ...prev, type: e.target.value }))}
                    className={`px-4 py-2 rounded-xl border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all ${
                      darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300'
                    }`}
                  >
                    <option value="all">Alle Typen</option>
                    <option value="school">Schule</option>
                    <option value="work">Arbeit</option>
                    <option value="study">Lernen</option>
                    <option value="sport">Sport</option>
                    <option value="test">Tests</option>
                    <option value="recurring">Wiederkehrend</option>
                  </select>
                </div>
              </div>

              {/* Day view */}
              <div className="p-4 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className={`text-xl md:text-2xl font-bold flex items-center gap-3 ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>
                    <span className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      {dayEmojis[currentDay]}
                    </span>
                    <span>
                      {days[currentDay]}
                      <span className={`text-sm font-normal ml-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        ({getFilteredTasks(getTasksForDay(currentDay)).length} {getFilteredTasks(getTasksForDay(currentDay)).length === 1 ? 'Aufgabe' : 'Aufgaben'})
                      </span>
                    </span>
                  </h2>
                  <button
                    onClick={() => setNewTaskForm({ show: true, day: currentDay })}
                    className="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg"
                  >
                    <Plus className="w-4 h-4" />
                    <span className="hidden sm:inline">Aufgabe hinzuf√ºgen</span>
                  </button>
                </div>

                {/* New task form */}
                {newTaskForm.show && newTaskForm.day === currentDay && (
                  <div className="mb-6">
                    <TaskForm
                      task={{}}
                      onSave={(taskData) => {
                        addNewTask(currentDay, taskData);
                        setNewTaskForm({ show: false, day: 0 });
                      }}
                      onCancel={() => setNewTaskForm({ show: false, day: 0 })}
                    />
                  </div>
                )}

                {/* Tasks list */}
                <div className="space-y-4">
                  {getFilteredTasks(getTasksForDay(currentDay)).length > 0 ? (
                    getFilteredTasks(getTasksForDay(currentDay)).map(task => (
                      <div
                        key={task.id}
                        className={`p-5 rounded-xl border transition-all hover:shadow-lg ${
                          darkMode 
                            ? 'bg-gray-700 border-gray-600 hover:border-blue-400' 
                            : 'bg-white border-gray-200 hover:border-blue-300'
                        }`}
                      >
                        {editingItem === task.id ? (
                          <TaskForm
                            task={task}
                            onSave={(updates) => {
                              updateTask(currentDay, task.id, updates);
                              setEditingItem(null);
                            }}
                            onCancel={() => setEditingItem(null)}
                          />
                        ) : (
                          <div className="flex flex-col">
                            <div className="flex justify-between items-start">
                              <div className="flex items-start gap-3 flex-1">
                                <span className={`text-2xl p-2 rounded-lg ${
                                  darkMode ? 'bg-gray-600' : 'bg-gray-100'
                                }`}>
                                  {getTypeEmoji(task.type)}
                                </span>
                                <div className="flex-1">
                                  <div className="flex flex-wrap items-center gap-2">
                                    <h3 className="font-semibold text-lg">{task.title}</h3>
                                    {task.recurring && (
                                      <span className={`text-xs px-2 py-1 rounded-full flex items-center gap-1 ${
                                        darkMode 
                                          ? 'bg-blue-900/50 text-blue-200' 
                                          : 'bg-blue-100 text-blue-800'
                                      }`}>
                                        <Repeat className="w-3 h-3" /> Wiederkehrend
                                      </span>
                                    )}
                                    {task.notification && (
                                      <span className={`text-xs px-2 py-1 rounded-full ${
                                        darkMode 
                                          ? 'bg-green-900/50 text-green-200' 
                                          : 'bg-green-100 text-green-800'
                                      }`}>
                                        üîî Erinnerung
                                      </span>
                                    )}
                                  </div>
                                  
                                  {task.time && (
                                    <p className={`text-sm flex items-center gap-2 mt-2 ${
                                      darkMode ? 'text-gray-300' : 'text-gray-600'
                                    }`}>
                                      <Clock className="w-4 h-4" /> {task.time}
                                    </p>
                                  )}
                                  
                                  {task.notes && (
                                    <p className={`text-sm mt-3 p-3 rounded-lg ${
                                      darkMode 
                                        ? 'bg-gray-800/50 text-gray-300' 
                                        : 'bg-gray-100 text-gray-600'
                                    }`}>
                                      {task.notes}
                                    </p>
                                  )}
                                  
                                  {task.type === 'test' && task.date && (
                                    <div className={`mt-3 text-sm p-3 rounded-lg flex items-center gap-2 ${
                                      darkMode 
                                        ? 'bg-blue-900/30 text-blue-200' 
                                        : 'bg-blue-100 text-blue-800'
                                    }`}>
                                      <Calendar className="w-4 h-4" />
                                      <span>
                                        {new Date(task.date).toLocaleDateString('de-DE')}
                                        {task.studyDays > 0 && ` | ${task.studyDays} Lerntage eingeplant`}
                                      </span>
                                    </div>
                                  )}
                                </div>
                              </div>
                              
                              {task.editable && (
                                <div className="flex gap-1">
                                  <button
                                    onClick={() => setEditingItem(task.id)}
                                    className={`p-2 rounded-lg transition-colors ${
                                      darkMode 
                                        ? 'text-blue-400 hover:bg-gray-600' 
                                        : 'text-blue-600 hover:bg-blue-50'
                                    }`}
                                  >
                                    <Edit2 className="w-4 h-4" />
                                  </button>
                                  <button
                                    onClick={() => deleteTask(currentDay, task.id)}
                                    className={`p-2 rounded-lg transition-colors ${
                                      darkMode 
                                        ? 'text-red-400 hover:bg-gray-600' 
                                        : 'text-red-600 hover:bg-red-50'
                                    }`}
                                  >
                                    <Trash2 className="w-4 h-4" />
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  ) : (
                    <div className={`text-center py-12 rounded-xl ${
                      darkMode ? 'bg-gray-800/50' : 'bg-gray-100'
                    }`}>
                      <Target className="w-12 h-12 mx-auto mb-4 opacity-50" />
                      <h3 className={`text-lg font-medium mb-1 ${
                        darkMode ? 'text-gray-300' : 'text-gray-700'
                      }`}>
                        Keine Aufgaben gefunden
                      </h3>
                      <p className={`text-sm ${
                        darkMode ? 'text-gray-500' : 'text-gray-600'
                      }`}>
                        {searchTerm 
                          ? 'Versuche deine Suche anzupassen' 
                          : 'F√ºge eine neue Aufgabe hinzu'}
                      </p>
                    </div>
                  )}
                </div>

                {/* Work overview */}
                {currentDay === 6 && (
                  <div className={`mt-8 p-6 rounded-xl ${
                    darkMode ? 'bg-gray-700/50 border border-gray-600' : 'bg-blue-50 border border-blue-200'
                  }`}>
                    <h3 className={`text-lg font-bold mb-4 flex items-center gap-2 ${
                      darkMode ? 'text-blue-300' : 'text-blue-800'
                    }`}>
                      <BookOpen className="w-5 h-5" />
                      üìä Kaufland Wochenarbeitszeit
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {[
                        { day: 'Dienstag', tasks: getTasksForDay(2).filter(t => t.type === 'work') },
                        { day: 'Donnerstag', tasks: getTasksForDay(4).filter(t => t.type === 'work') },
                        { day: 'Samstag', tasks: getTasksForDay(6).filter(t => t.type === 'work') }
                      ].map((dayData, index) => (
                        <div 
                          key={index} 
                          className={`p-4 rounded-xl border shadow-sm ${
                            darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'
                          }`}
                        >
                          <div className={`font-medium ${
                            darkMode ? 'text-gray-200' : 'text-gray-800'
                          }`}>
                            {dayData.day}
                          </div>
                          {dayData.tasks.map((task, i) => (
                            <div 
                              key={i} 
                              className={`mt-2 text-sm ${
                                darkMode ? 'text-gray-400' : 'text-gray-600'
                              }`}
                            >
                              {task.time}
                            </div>
                          ))}
                          <div className={`mt-2 font-semibold ${
                            darkMode ? 'text-blue-400' : 'text-blue-600'
                          }`}>
                            {index === 2 ? '3 Stunden' : '2,5 Stunden'}
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className={`mt-4 text-center p-3 rounded-xl font-bold shadow-md ${
                      darkMode 
                        ? 'bg-gradient-to-r from-blue-800 to-indigo-800' 
                        : 'bg-gradient-to-r from-blue-500 to-indigo-500'
                    } text-white`}>
                      Gesamt: 8 Stunden pro Woche
                    </div>
                  </div>
                )}
              </div>
            </>
          ) : (
            /* Week view */
            <div className="p-4 md:p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className={`text-xl md:text-2xl font-bold flex items-center gap-2 ${
                  darkMode ? 'text-gray-100' : 'text-gray-800'
                }`}>
                  <Calendar className="w-6 h-6" />
                  Wochen√ºbersicht
                </h2>
                <div className="flex gap-2">
                  <button
                    onClick={() => navigateWeek(-1)}
                    className={`p-2 rounded-lg ${
                      darkMode 
                        ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' 
                        : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                    } transition-colors`}
                  >
                    <ChevronLeft className="w-5 h-5" />
                  </button>
                  <button
                    onClick={() => navigateWeek(1)}
                    className={`p-2 rounded-lg ${
                      darkMode 
                        ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' 
                        : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                    } transition-colors`}
                  >
                    <ChevronRight className="w-5 h-5" />
                  </button>
                </div>
              </div>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {days.map((day, dayIndex) => {
                  const date = weekDates[dayIndex];
                  return (
                    <div 
                      key={dayIndex} 
                      className={`rounded-xl p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}
                    >
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <span className="text-xl">{dayEmojis[dayIndex]}</span>
                          <h3 className={`font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                            {day}
                          </h3>
                        </div>
                        <span className={`text-xs ${
                          darkMode ? 'text-gray-400' : 'text-gray-500'
                        }`}>
                          {date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}
                        </span>
                      </div>
                      
                      <div className="space-y-2">
                        {getTasksForDay(dayIndex).slice(0, 5).map(task => (
                          <div
                            key={task.id}
                            className={`p-3 rounded-lg text-sm ${
                              darkMode 
                                ? 'bg-gray-600 hover:bg-gray-500' 
                                : 'bg-white hover:bg-gray-50'
                            } transition-colors shadow-sm`}
                          >
                            <div className="flex items-center gap-2">
                              <span className="text-lg">{getTypeEmoji(task.type)}</span>
                              <div className="flex-1 min-w-0">
                                <div className="font-medium truncate">{task.title}</div>
                                {task.time && (
                                  <div className={`text-xs mt-1 flex items-center gap-1 ${
                                    darkMode ? 'text-gray-300' : 'text-gray-600'
                                  }`}>
                                    <Clock className="w-3 h-3" /> {task.time}
                                  </div>
                                )}
                              </div>
                              {task.recurring && (
                                <Repeat className="w-4 h-4 flex-shrink-0 text-blue-500" />
                              )}
                            </div>
                          </div>
                        ))}
                        
                        {getTasksForDay(dayIndex).length > 5 && (
                          <div className={`text-center py-2 text-xs ${
                            darkMode ? 'text-gray-500' : 'text-gray-400'
                          }`}>
                            +{getTasksForDay(dayIndex).length - 5} weitere...
                          </div>
                        )}
                        
                        {getTasksForDay(dayIndex).length === 0 && (
                          <div className={`text-center py-4 text-xs italic ${
                            darkMode ? 'text-gray-500' : 'text-gray-400'
                          }`}>
                            Keine Aufgaben
                          </div>
                        )}
                      </div>
                      
                      <button
                        onClick={() => {
                          setCurrentDay(dayIndex);
                          setShowWeekView(false);
                        }}
                        className={`w-full mt-3 text-sm py-2 rounded-lg transition-colors ${
                          darkMode 
                            ? 'bg-gray-600 hover:bg-gray-500 text-white' 
                            : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                        }`}
                      >
                        Zu {day} wechseln
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </main>
      </div>
    </div>
  );
};

export default WeeklyPlanner;
