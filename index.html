<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mein Wochenplaner (privat)</title>

  <!-- Tailwind Play CDN (für Single-File ohne Build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Kleine Ergänzungen / Animationen */
    .fade-in { animation: fadeIn .25s ease-out both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%, 90% { transform: translateX(-2px); } 20%, 80% { transform: translateX(4px); } 30%, 50%, 70% { transform: translateX(-6px); } 40%, 60% { transform: translateX(6px); } }
    .task-dragging { opacity: 0.85; transform: scale(1.02); box-shadow: 0 8px 22px rgba(0,0,0,.12); }
    .day-drop-hover { background: linear-gradient(90deg, rgba(99,102,241,0.06), rgba(79,70,229,0.03)); }
    .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
    /* small screens tuning */
    @media (max-width: 640px) {
      .day-column { min-width: 230px; }
    }
  </style>

  <!-- SortableJS für Drag & Drop (kein React nötig) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen antialiased">

  <!-- Password Modal -->
  <div id="pw-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div id="pw-box" class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 shadow-2xl transform transition-transform fade-in">
      <h2 class="text-2xl font-bold mb-2">Zugang</h2>
      <p class="mb-4 text-sm text-slate-600">Diese Seite ist privat. Bitte Passwort eingeben.</p>
      <input id="pw-input" type="password" placeholder="Passwort" class="w-full px-4 py-2 rounded-lg border border-slate-200 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
      <div class="flex gap-2">
        <button id="pw-submit" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Öffnen</button>
        <button id="pw-cancel" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition">Schließen</button>
      </div>
      <p id="pw-error" class="text-red-600 text-sm mt-3 hidden">Falsches Passwort.</p>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
    <div class="rounded-2xl bg-white shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="p-5 bg-gradient-to-r from-indigo-600 to-indigo-400 text-white flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">📅 Mein Wochenplaner</h1>
          <p class="text-sm opacity-90 mt-1">Nur für mich — kein Teilen, keine Werbung.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="export-ical" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white transition">ICS export</button>
          <button id="toggle-view" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white transition">Wochen-/Tagesansicht</button>
          <button id="clear-all" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white text-sm transition">Alles löschen</button>
        </div>
      </div>

      <!-- Stats + Controls -->
      <div class="p-4 border-b bg-slate-50 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex gap-3 items-center">
          <div class="p-3 rounded-lg bg-white border shadow-sm text-center min-w-[80px]">
            <div id="stat-work" class="text-lg font-bold">0h</div>
            <div class="text-xs text-slate-500">Arbeitszeit</div>
          </div>
          <div class="p-3 rounded-lg bg-white border shadow-sm text-center min-w-[80px]">
            <div id="stat-study" class="text-lg font-bold">0</div>
            <div class="text-xs text-slate-500">Lernaufgaben</div>
          </div>
          <div class="p-3 rounded-lg bg-white border shadow-sm text-center min-w-[80px]">
            <div id="stat-sport" class="text-lg font-bold">0</div>
            <div class="text-xs text-slate-500">Sport</div>
          </div>
        </div>

        <div class="flex gap-2">
          <input id="search" class="px-3 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-200" placeholder="Aufgaben suchen..." />
          <button id="add-task-open" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Aufgabe hinzufügen</button>
        </div>
      </div>

      <!-- Content -->
      <div id="content" class="p-4">
        <!-- Tages/Wochenansicht (default Tagesansicht) -->
        <div id="day-view" class="fade-in">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <button id="prev-day" class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200">&lt;</button>
              <h2 id="current-day-title" class="text-2xl font-bold">Montag</h2>
              <button id="next-day" class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200">&gt;</button>
              <div id="day-task-count" class="text-sm text-slate-500">0 Aufgaben</div>
            </div>
            <div class="text-sm text-slate-500">Ziehe Aufgaben, um sie zu verschieben</div>
          </div>

          <!-- Tasks list -->
          <div id="day-tasks" class="space-y-3"></div>
        </div>

        <div id="week-view" class="hidden fade-in">
          <div class="flex overflow-x-auto gap-3 py-2 pb-4">
            <!-- Wochen-Spalten (werden dynamisch gefüllt) -->
          </div>
        </div>
      </div>
    </div>

    <!-- Footer / Report button -->
    <div class="max-w-6xl mx-auto mt-4 p-2 text-sm text-slate-600">
      <div class="flex gap-2 items-center">
        <button id="open-report" class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200 transition">Kurzer Bericht (lesen)</button>
        <span class="text-xs opacity-80">Keine Werbung — nur privat.</span>
      </div>
      <div id="report" class="mt-3 p-3 bg-white border rounded hidden text-sm text-slate-700">
        <!-- Report wird hier eingefügt -->
      </div>
    </div>
  </div>

  <!-- Add/Edit Task Modal -->
  <div id="task-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-xl shadow-2xl">
      <h3 id="task-modal-title" class="text-lg font-semibold mb-2">Aufgabe hinzufügen</h3>
      <div class="grid grid-cols-1 gap-3">
        <input id="task-title" placeholder="Titel" class="px-3 py-2 border rounded" />
        <input id="task-time" placeholder="Zeit (z.B. 19:00 – 20:00)" class="px-3 py-2 border rounded" />
        <select id="task-type" class="px-3 py-2 border rounded">
          <option value="school">Schule</option>
          <option value="study" selected>Schulvorbereitung</option>
          <option value="work">Arbeit</option>
          <option value="sport">Sport</option>
          <option value="music">Musik</option>
          <option value="free">Freizeit</option>
          <option value="test">Test/Klausur</option>
          <option value="appointment">Termin</option>
          <option value="hobby">Hobby</option>
        </select>
        <label class="flex items-center gap-2">
          <input id="task-recurring" type="checkbox" /> Wöchentlich wiederkehrend
        </label>
        <label class="flex items-center gap-2">
          <input id="task-notify" type="checkbox" /> Erinnerung (Browser-Benachrichtigung)
        </label>
        <div class="flex gap-2 justify-end">
          <button id="task-cancel" class="px-4 py-2 rounded bg-slate-100 hover:bg-slate-200">Abbrechen</button>
          <button id="task-save" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Speichern</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===============================
   Single-file Wochenplaner (DE)
   - localStorage-basiert
   - wöchentlicher Reset mit merge recurring
   - Drag & Drop (SortableJS)
   - Passwort-Modal (Timon1605)
   - Sonntag: Schulvorbereitung 20:30–21:00 automatisch
   - Keine Werbung / privat
   =============================== */

(() => {
  'use strict';

  /* ---------- Konfiguration ---------- */
  const PASSWORD = 'Timon1605';
  const STORAGE_KEY = 'weeklyPlannerSchedule_v1';
  const WEEK_KEY = 'weeklyPlannerWeek_v1';

  const days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
  const dayEmojis = ['😴','🏫','🏫','🏫','🏫','🏫','🏋️‍♀️'];

  /* ---------- Hilfsfunktionen ---------- */
  function safeParse(json) {
    try { return JSON.parse(json); } catch (e) { return null; }
  }
  function safeSetItem(k, v) {
    try { localStorage.setItem(k, JSON.stringify(v)); return true; }
    catch (e) { console.error('localStorage set failed', e); return false; }
  }
  function safeGetItem(k) {
    try { return localStorage.getItem(k); } catch(e){ console.error('localStorage get failed', e); return null; }
  }
  function weekNumber(date = new Date()) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart)/86400000)+1)/7);
  }

  /* ---------- Initial Schedule (Base) ---------- */
  function getBaseSchedule() {
    // ensure Sunday has 'Schulvorbereitung 20:30 – 21:00'
    return {
      0: [ { id: idGen(), type:'study', title:'Schulvorbereitung', time:'20:30 – 21:00', recurring:true, editable:true, notification:false } ],
      1: [ { id: idGen(), type:'school', title:'Schule', time:'08:00 – 15:15', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'music', title:'Musikunterricht', time:'15:30 – 16:30', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'study', title:'Schulvorbereitung', time:'19:00 – 20:00', recurring:true, editable:true, notification:false } ],
      2: [ { id: idGen(), type:'school', title:'Schule', time:'08:00 – 15:15', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'work', title:'Kaufland', time:'16:00 – 18:30', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'study', title:'Schulvorbereitung', time:'19:00 – 20:00', recurring:true, editable:true, notification:false } ],
      3: [ { id: idGen(), type:'school', title:'Schule', time:'08:00 – 13:10', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'sport', title:'Tischtennis', time:'17:00 – 18:30', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'study', title:'Schulvorbereitung', time:'19:00 – 20:00', recurring:true, editable:true, notification:false } ],
      4: [ { id: idGen(), type:'school', title:'Schule', time:'08:00 – 15:15', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'work', title:'Kaufland', time:'16:30 – 19:00', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'study', title:'Schulvorbereitung', time:'19:30 – 20:30', recurring:true, editable:true, notification:false } ],
      5: [ { id: idGen(), type:'school', title:'Schule', time:'08:00 – 13:10', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'sport', title:'Schwimmen', time:'16:30 – 17:15', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'study', title:'Schulnachbereitung', time:'20:00 – 21:00', recurring:true, editable:true, notification:false } ],
      6: [ { id: idGen(), type:'sport', title:'Gym', time:'08:30 – 10:00', recurring:true, editable:true, notification:false },
           { id: idGen(), type:'work', title:'Kaufland', time:'10:30 – 13:30', recurring:true, editable:true, notification:false } ]
    };
  }

  /* ID Generator (simple) */
  function idGen() {
    return Math.floor(Date.now() + Math.random()*10000);
  }

  /* Merge recurring user tasks into base schedule for new week */
  function mergeRecurring(base, old) {
    const merged = JSON.parse(JSON.stringify(base));
    if (!old) return merged;
    Object.keys(old).forEach(k => {
      const day = parseInt(k,10);
      const tasks = old[k] || [];
      const userRecurring = tasks.filter(t => t.recurring && t.editable && !isBase(t, day, base));
      if (userRecurring.length) {
        merged[day] = [...merged[day] || [], ...userRecurring.map(t => ({ ...t, id: idGen() }))];
      }
    });
    return merged;
  }

  function isBase(task, day, base) {
    const baseTasks = (base && base[day]) || [];
    return baseTasks.some(bt => bt.title === task.title && bt.type === task.type && bt.time === task.time);
  }

  /* ---------- App State ---------- */
  let schedule = null; // object with arrays per day index 0-6
  let currentDay = new Date().getDay(); // index 0-6 (Sun-Sat)
  let showWeek = false;

  /* ---------- DOM Elements ---------- */
  const pwModal = document.getElementById('pw-modal');
  const pwInput = document.getElementById('pw-input');
  const pwSubmit = document.getElementById('pw-submit');
  const pwCancel = document.getElementById('pw-cancel');
  const pwBox = document.getElementById('pw-box');
  const pwError = document.getElementById('pw-error');

  const appEl = document.getElementById('app');
  const currentTitle = document.getElementById('current-day-title');
  const dayTasksEl = document.getElementById('day-tasks');
  const dayTaskCount = document.getElementById('day-task-count');
  const prevDayBtn = document.getElementById('prev-day');
  const nextDayBtn = document.getElementById('next-day');
  const toggleViewBtn = document.getElementById('toggle-view');
  const weekViewEl = document.getElementById('week-view');
  const dayViewEl = document.getElementById('day-view');
  const weekColumnsContainer = weekViewEl.querySelector('.flex');

  const addTaskOpen = document.getElementById('add-task-open');
  const taskModal = document.getElementById('task-modal');
  const taskModalTitle = document.getElementById('task-modal-title');
  const taskTitleInput = document.getElementById('task-title');
  const taskTimeInput = document.getElementById('task-time');
  const taskTypeInput = document.getElementById('task-type');
  const taskRecurringInput = document.getElementById('task-recurring');
  const taskNotifyInput = document.getElementById('task-notify');
  const taskSaveBtn = document.getElementById('task-save');
  const taskCancelBtn = document.getElementById('task-cancel');

  const searchInput = document.getElementById('search');
  const statWork = document.getElementById('stat-work');
  const statStudy = document.getElementById('stat-study');
  const statSport = document.getElementById('stat-sport');

  const exportIcsBtn = document.getElementById('export-ical');
  const clearAllBtn = document.getElementById('clear-all');

  const toggleViewText = toggleViewBtn;

  const openReportBtn = document.getElementById('open-report');
  const reportEl = document.getElementById('report');

  /* ---------- Init / Load ---------- */
  function init() {
    // password handlers
    pwSubmit.addEventListener('click', tryPassword);
    pwInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryPassword(); });
    pwCancel.addEventListener('click', () => { window.close?.(); }); // best-effort

    // app handlers (after auth)
    prevDayBtn.addEventListener('click', () => { currentDay = (currentDay === 0 ? 6 : currentDay - 1); render(); });
    nextDayBtn.addEventListener('click', () => { currentDay = (currentDay === 6 ? 0 : currentDay + 1); render(); });
    toggleViewBtn.addEventListener('click', () => { showWeek = !showWeek; renderView(); });
    addTaskOpen.addEventListener('click', () => openTaskModal());
    taskCancelBtn.addEventListener('click', closeTaskModal);
    taskSaveBtn.addEventListener('click', onSaveTask);
    searchInput.addEventListener('input', render);
    exportIcsBtn.addEventListener('click', exportToICal);
    clearAllBtn.addEventListener('click', clearAllConfirm);
    openReportBtn.addEventListener('click', toggleReport);

    // Initialize schedule with weekly reset logic
    loadSchedule();

    // Start periodic check for notifications (if enabled on tasks)
    setInterval(checkReminders, 60 * 1000); // every minute
  }

  function tryPassword() {
    const val = pwInput.value.trim();
    if (val === PASSWORD) {
      pwModal.classList.add('hidden');
      appEl.classList.remove('hidden');
      // focus search for convenience
      setTimeout(() => { searchInput.focus(); }, 350);
      render();
    } else {
      pwError.classList.remove('hidden');
      pwBox.classList.remove('fade-in');
      pwBox.classList.add('shake');
      setTimeout(() => { pwBox.classList.remove('shake'); }, 360);
    }
  }

  function loadSchedule() {
    const saved = safeGetItem(STORAGE_KEY);
    const lastWeek = safeGetItem(WEEK_KEY);
    const currentWeek = weekNumber(new Date()).toString();

    const base = getBaseSchedule();

    if (!saved || !lastWeek || lastWeek !== currentWeek) {
      // New week -> merge recurring user tasks if any
      const old = saved ? safeParse(saved) : null;
      schedule = mergeRecurring(base, old);
      safeSetItem(WEEK_KEY, currentWeek);
      safeSetItem(STORAGE_KEY, schedule);
      return;
    }

    const parsed = safeParse(saved);
    if (parsed) {
      schedule = parsed;
    } else {
      schedule = base;
      safeSetItem(STORAGE_KEY, schedule);
    }
  }

  function saveSchedule() {
    safeSetItem(STORAGE_KEY, schedule);
    updateStats();
  }

  /* ---------- Rendering ---------- */
  function render() {
    if (showWeek) {
      renderWeek();
      return;
    }
    // day view rendering
    currentTitle.textContent = `${dayEmojis[currentDay]} ${days[currentDay]}`;
    const tasks = getFilteredTasksForDay(currentDay);
    dayTaskCount.textContent = `${tasks.length} Aufgaben`;
    dayTasksEl.innerHTML = '';
    if (!tasks.length) {
      dayTasksEl.innerHTML = `<div class="text-center py-12 text-slate-500">
        <div class="text-lg font-medium">Keine Aufgaben</div>
        <div class="text-sm mt-2">Füge eine Aufgabe hinzu oder ändere den Filter.</div>
      </div>`;
    } else {
      tasks.forEach(t => {
        const el = taskCardElement(t);
        dayTasksEl.appendChild(el);
      });
    }
    // make day list sortable
    makeSortableForContainer(dayTasksEl, currentDay);
    updateStats();
  }

  function renderView() {
    if (showWeek) {
      dayViewEl.classList.add('hidden');
      weekViewEl.classList.remove('hidden');
      renderWeek();
    } else {
      weekViewEl.classList.add('hidden');
      dayViewEl.classList.remove('hidden');
      render();
    }
  }

  function renderWeek() {
    // fill week columns
    const query = searchInput.value.trim().toLowerCase();
    weekColumnsContainer.innerHTML = '';
    for (let i = 0; i < 7; i++) {
      const column = document.createElement('div');
      column.className = 'day-column min-w-[260px] bg-white p-3 rounded-lg border shadow-sm no-select';
      column.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <div class="text-xl">${dayEmojis[i]}</div>
            <div class="font-semibold">${days[i]}</div>
            <div class="text-xs text-slate-500">(${(schedule[i]||[]).length})</div>
          </div>
          <button class="text-xs px-2 py-1 bg-indigo-50 rounded text-indigo-700" data-goto="${i}">Zu Tag</button>
        </div>
        <div class="day-list space-y-2 min-h-[60px]"></div>
      `;
      // append tasks
      const list = column.querySelector('.day-list');
      const tasks = (schedule[i] || []).filter(t => filterBySearch(t, query));
      tasks.forEach(t => list.appendChild(taskCardElement(t)));
      weekColumnsContainer.appendChild(column);

      // goto button handler
      column.querySelector('[data-goto]').addEventListener('click', (e) => {
        currentDay = parseInt(e.target.getAttribute('data-goto'),10);
        showWeek = false;
        renderView();
      });

      // make sortable
      makeSortableForContainer(list, i);
    }
  }

  function taskCardElement(task) {
    const wrapper = document.createElement('div');
    wrapper.className = 'task-card p-3 bg-slate-50 border rounded-lg flex justify-between items-start gap-3 transition hover:shadow-md';
    wrapper.setAttribute('data-id', task.id);
    wrapper.setAttribute('data-day', findTaskDay(task.id));
    wrapper.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="text-2xl">${typeEmoji(task.type)}</div>
        <div>
          <div class="font-semibold">${escapeHtml(task.title || '')} ${task.recurring ? '<span class="text-xs bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded ml-2">wöchentlich</span>' : ''} ${task.notification ? '<span class="text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded ml-2">🔔</span>' : ''}</div>
          ${task.time ? `<div class="text-xs text-slate-500 mt-1">${escapeHtml(task.time)}</div>` : ''}
        </div>
      </div>
      <div class="flex gap-2 items-start">
        <button class="edit-btn text-slate-600 hover:text-indigo-600" title="Bearbeiten">✏️</button>
        <button class="del-btn text-slate-600 hover:text-red-600" title="Löschen">🗑️</button>
      </div>
    `;
    // edit & delete handlers
    wrapper.querySelector('.edit-btn').addEventListener('click', () => openTaskModal(task));
    wrapper.querySelector('.del-btn').addEventListener('click', () => {
      if (confirm('Aufgabe endgültig löschen?')) {
        deleteTaskById(task.id);
        render();
      }
    });
    return wrapper;
  }

  function escapeHtml(s) {
    return (s+'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function typeEmoji(type) {
    const map = {
      school: '🏫', work: '🛒', study: '🧠', sport: '🏊', music:'🎼', lesson:'📘', free:'🎯', sleep:'😴', test:'📝', appointment:'📅', hobby:'🎨'
    };
    return map[type] || '📋';
  }

  /* ---------- Task Operations ---------- */
  function addTaskToDay(day, partial) {
    const newTask = {
      id: idGen(),
      type: partial.type || 'study',
      title: partial.title || '',
      time: partial.time || '',
      recurring: !!partial.recurring,
      editable: true,
      notification: !!partial.notification
    };
    schedule[day] = schedule[day] || [];
    schedule[day].push(newTask);
    saveSchedule();
    render();
    return newTask;
  }

  function updateTaskInSchedule(taskId, updates) {
    for (let d = 0; d < 7; d++) {
      const list = schedule[d] || [];
      const idx = list.findIndex(t=>t.id===taskId);
      if (idx !== -1) {
        schedule[d][idx] = { ...schedule[d][idx], ...updates };
        saveSchedule();
        return schedule[d][idx];
      }
    }
    return null;
  }

  function deleteTaskById(taskId) {
    for (let d=0; d<7; d++) {
      schedule[d] = (schedule[d]||[]).filter(t=>t.id!==taskId);
    }
    saveSchedule();
  }

  function findTaskDay(taskId) {
    for (let d=0; d<7; d++) {
      const idx = (schedule[d]||[]).findIndex(t=>t.id===taskId);
      if (idx !== -1) return d;
    }
    return -1;
  }

  /* ---------- Search & Filter ---------- */
  function filterBySearch(task, query) {
    if (!query) return true;
    const q = query.toLowerCase();
    return (task.title || '').toLowerCase().includes(q) || (task.time||'').toLowerCase().includes(q) || (task.type||'').toLowerCase().includes(q);
  }

  function getFilteredTasksForDay(day) {
    const arr = schedule[day] || [];
    const q = searchInput.value.trim().toLowerCase();
    return arr.filter(t => filterBySearch(t, q));
  }

  /* ---------- Task Modal ---------- */
  let editingTask = null;
  function openTaskModal(task = null) {
    editingTask = task;
    taskModal.classList.remove('hidden');
    // fill fields
    taskModalTitle.textContent = task ? 'Aufgabe bearbeiten' : 'Aufgabe hinzufügen';
    taskTitleInput.value = task?.title || '';
    taskTimeInput.value = task?.time || '';
    taskTypeInput.value = task?.type || 'study';
    taskRecurringInput.checked = !!task?.recurring;
    taskNotifyInput.checked = !!task?.notification;
  }
  function closeTaskModal() {
    editingTask = null;
    taskModal.classList.add('hidden');
  }
  function onSaveTask() {
    const title = taskTitleInput.value.trim();
    if (!title) return alert('Titel eingeben.');
    const data = {
      title,
      time: taskTimeInput.value.trim(),
      type: taskTypeInput.value,
      recurring: taskRecurringInput.checked,
      notification: taskNotifyInput.checked
    };
    if (editingTask) {
      updateTaskInSchedule(editingTask.id, data);
    } else {
      addTaskToDay(currentDay, data);
    }
    closeTaskModal();
  }

  /* ---------- Drag & Drop (SortableJS) ---------- */
  const sortableMap = new Map();
  function makeSortableForContainer(containerEl, dayIndex) {
    // Destroy existing Sortable on this container if any
    const key = containerEl;
    if (sortableMap.has(key)) {
      try { sortableMap.get(key).destroy(); } catch(e) {}
      sortableMap.delete(key);
    }
    // store items order by nodes currently in container => ensure underlying schedule matches
    const options = {
      group: 'week-tasks',
      animation: 150,
      ghostClass: 'task-dragging',
      onAdd: function (evt) {
        // moved from another list to this dayIndex
        const id = parseInt(evt.item.getAttribute('data-id'),10);
        const fromDay = parseInt(evt.from.closest('.day-column')?.querySelector('[data-goto]')?.getAttribute('data-goto') || evt.from.parentElement?.getAttribute('data-day'), 10);
        // If cannot detect fromDay, fallback to findTaskDay
        const detectedFrom = findTaskDay(id);
        // remove from old day
        for (let d=0; d<7; d++) schedule[d] = (schedule[d]||[]).filter(t=>t.id!==id);
        // insert at new position
        const insertIndex = Array.from(evt.to.children).indexOf(evt.item);
        schedule[dayIndex] = schedule[dayIndex] || [];
        schedule[dayIndex].splice(insertIndex, 0, getTaskByIdOrCreate(id, evt.item));
        saveSchedule();
        render();
      },
      onUpdate: function (evt) {
        // reorder within same list
        const id = parseInt(evt.item.getAttribute('data-id'),10);
        const list = schedule[dayIndex] = schedule[dayIndex] || [];
        const ids = Array.from(evt.to.children).map(c => parseInt(c.getAttribute('data-id'),10));
        schedule[dayIndex] = ids.map(i => list.find(t=>t.id===i) || getTaskByIdOrCreate(i));
        saveSchedule();
        render();
      },
      onStart: function (evt) {
        evt.item.classList.add('task-dragging');
      },
      onEnd: function (evt) {
        evt.item.classList.remove('task-dragging');
      }
    };
    // attach 'data-day' to container for fallback detection
    containerEl.setAttribute('data-day', dayIndex);
    const s = new Sortable(containerEl, options);
    sortableMap.set(key, s);
  }

  function getTaskByIdOrCreate(id, el) {
    // find in schedule (previous weeks merge could have new copies)
    for (let d=0; d<7; d++) {
      const t = (schedule[d]||[]).find(tt=>tt.id===id);
      if (t) return t;
    }
    // fallback: construct from DOM
    if (el) {
      const title = el.querySelector('.font-semibold')?.textContent || 'Aufgabe';
      const time = el.querySelector('.text-slate-500')?.textContent || '';
      return { id, title, time, type:'study', recurring:false, editable:true, notification:false };
    }
    return { id, title:'Aufgabe', type:'study', recurring:false, editable:true, notification:false };
  }

  function getTaskById(id) {
    for (let d=0; d<7; d++) {
      const t = (schedule[d]||[]).find(tt=>tt.id===id);
      if (t) return t;
    }
    return null;
  }

  /* ---------- Notifications (basic) ---------- */
  function checkReminders() {
    if (!('Notification' in window)) return;
    const now = new Date();
    const hhmm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    for (let d = 0; d < 7; d++) {
      const tasks = schedule[d] || [];
      tasks.forEach(t => {
        if (t.notification && t.time && t.time.includes(hhmm)) {
          // check permission
          if (Notification.permission === 'granted') {
            new Notification(`Erinnerung: ${t.title}`, { body: `${t.time} (${days[d]})` });
          } else if (Notification.permission === 'default') {
            Notification.requestPermission().then(p => { if (p === 'granted') new Notification(`Erinnerung: ${t.title}`, { body: `${t.time} (${days[d]})` }); });
          }
        }
      });
    }
  }

  /* ---------- Export iCal (rudimentär) ---------- */
  function exportToICal() {
    const ical = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//WeeklyPlanner//DE'];
    const today = new Date();
    Object.entries(schedule).forEach(([dayIndex,tasks]) => {
      tasks.forEach(task => {
        if (!task.time) return;
        const parts = task.time.split('–').map(p=>p.trim());
        const start = parts[0] || '';
        const end = parts[1] || start;
        // naive date: next occurrence of this weekday
        const dindex = parseInt(dayIndex,10);
        const date = nextDateForWeekday(dindex);
        const yyyy = date.toISOString().split('T')[0].replace(/-/g,'');
        const startClean = start.replace(':','') + '00';
        const endClean = end.replace(':','') + '00';
        ical.push('BEGIN:VEVENT');
        ical.push(`SUMMARY:${task.title}`);
        ical.push(`DTSTART:${yyyy}T${startClean}`);
        ical.push(`DTEND:${yyyy}T${endClean}`);
        ical.push('END:VEVENT');
      });
    });
    ical.push('END:VCALENDAR');
    const blob = new Blob([ical.join('\n')], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'wochenplan.ics'; document.body.appendChild(a); a.click();
    a.remove(); URL.revokeObjectURL(url);
  }

  function nextDateForWeekday(weekday) {
    const today = new Date();
    const todayIdx = today.getDay();
    let diff = weekday - todayIdx;
    if (diff < 0) diff += 7;
    const res = new Date(today);
    res.setDate(today.getDate() + diff);
    return res;
  }

  /* ---------- Utils / Stats ---------- */
  function updateStats() {
    const all = Object.values(schedule).flat();
    // naive work hours calc based on known times from base schedule
    const workHours = all.filter(t=>t.type==='work').reduce((s,t)=>{
      if (t.time.includes('16:00') && t.time.includes('18:30')) return s + 2.5;
      if (t.time.includes('16:30') && t.time.includes('19:00')) return s + 2.5;
      if (t.time.includes('10:30') && t.time.includes('13:30')) return s + 3;
      return s;
    }, 0);
    statWork.textContent = `${workHours}h`;
    statStudy.textContent = `${all.filter(t=>t.type==='study').length}`;
    statSport.textContent = `${all.filter(t=>t.type==='sport').length}`;
  }

  function clearAllConfirm() {
    if (!confirm('Alle Aufgaben unwiderruflich löschen? (Basis-Woche wird neu geladen)')) return;
    schedule = getBaseSchedule();
    safeSetItem(WEEK_KEY, weekNumber(new Date()).toString());
    saveSchedule();
    render();
  }

  /* ---------- Helpers ---------- */
  function deleteAllEmptyDays() {
    for (let i=0;i<7;i++) schedule[i] = schedule[i] || [];
  }

  /* ---------- simple HTML helpers ---------- */
  function makeEl(tag, cls, html) {
    const e = document.createElement(tag);
    e.className = cls || '';
    if (html) e.innerHTML = html;
    return e;
  }

  /* ---------- Report ---------- */
  function toggleReport() {
    if (reportEl.classList.contains('hidden')) {
      reportEl.classList.remove('hidden');
      reportEl.innerHTML = `
        <strong>Kurzer Entwicklungsbericht</strong>
        <ul class="list-disc pl-5 mt-2">
          <li>Clientseitiger Passwortschutz: <code>${PASSWORD}</code> (einfacher Schutz, rein clientseitig).</li>
          <li>Speicherung lokal in <code>localStorage</code>. Keine Cloud, keine Datenweitergabe.</li>
          <li>Wöchentlicher Reset mit Beibehaltung als 'wiederkehrend' markierter Aufgaben.</li>
          <li>Drag & Drop mit SortableJS: Aufgaben lassen sich zwischen Tagen verschieben und innerhalb eines Tages sortieren.</li>
          <li>Sonntag enthält automatisch <em>Schulvorbereitung 20:30–21:00</em>.</li>
        </ul>
        <div class="mt-3">
          <strong>Was noch verbessert werden könnte</strong>
          <ol class="pl-5 list-decimal mt-2">
            <li>Serverseitiger Schutz / Authentifizierung (falls nötig).</li>
            <li>Persistente Push-Benachrichtigungen (Service Worker) für zuverlässigere Erinnerungen.</li>
            <li>Unit-Tests & E2E-Tests (z. B. Vitest / Playwright) — schwer in Single-File bereitzustellen.</li>
            <li>Bessere Konfliktbehandlung bei mehreren Geräten (aktuell nur lokal).</li>
            <li>Feinschliff bei Drag & Drop Animationen / Barrierefreiheit.</li>
          </ol>
        </div>
        <div class="mt-3 text-xs text-slate-500">Kein Tracking. Kein Promo. Nur privat für dich.</div>
      `;
    } else {
      reportEl.classList.add('hidden');
    }
  }

  /* ---------- Utilities for saving/loading tasks after DnD ---------- */
  function rebuildScheduleFromDOM() {
    // optional, not used now
  }

  /* ---------- find-or-create helper ---------- */
  function getTaskByIdOrCreate(id) { return getTaskById(id) || { id, title:'Aufgabe', time:'', type:'study', recurring:false, editable:true, notification:false }; }

  /* ---------- delete empty lists / normalization ---------- */
  function normalizeSchedule() {
    for (let i=0;i<7;i++) schedule[i] = schedule[i] || [];
  }

  /* ---------- init and run ---------- */
  init();

  // Expose some functions for dev console if needed
  window._planner = {
    get schedule() { return schedule; },
    set schedule(v) { schedule = v; saveSchedule(); render(); },
    resetToBase: () => { schedule = getBaseSchedule(); saveSchedule(); render(); },
    exportICal: exportToICal,
    password: PASSWORD
  };

})();
</script>
</body>
</html>
